<?xml version="1.0" encoding="UTF-8" ?>
<ruleset
	xmlns="http://pmd.sourceforge.net/ruleset/2.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	name="Default ruleset used by the CodeClimate Engine for Salesforce.com Apex"
	xsi:schemaLocation="http://pmd.sourceforge.net/ruleset/2.0.0 http://pmd.sourceforge.net/ruleset_2_0_0.xsd"
>
	<description>Default ruleset used by the Code Climate Engine for Salesforce.com Apex</description>
	<exclude-pattern>.*/.sfdx/.*</exclude-pattern>


	<!-- Best Practices -->
	<rule ref="category/apex/bestpractices.xml/ApexAssertionsShouldIncludeMessage">
		<priority>2</priority>
	</rule>
	<rule
		ref="category/apex/bestpractices.xml/ApexUnitTestClassShouldHaveAsserts"
		message="Apex unit test classes should have at least one System.assert() or assertEquals() or AssertNotEquals() call"
	>
		<priority>5</priority>
	</rule>
	<rule ref="category/apex/bestpractices.xml/ApexUnitTestMethodShouldHaveIsTestAnnotation">
		<priority>5</priority>
	</rule>
	<rule
		ref="category/apex/bestpractices.xml/ApexUnitTestShouldNotUseSeeAllDataTrue"
		message="@isTest(seeAllData=true) should not be used in Apex unit tests because it opens up the existing database data for unexpected modification by tests"
	>
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/bestpractices.xml/AvoidGlobalModifier" message="Avoid using global modifier">
		<priority>4</priority>
	</rule>
	<rule ref="category/apex/bestpractices.xml/AvoidLogicInTrigger" message="Avoid logic in triggers">
		<priority>1</priority>
	</rule>
	<!-- TODO: review. Possible conflictive rule with Debug Custom -->
	<rule ref="category/apex/bestpractices.xml/DebugsShouldUseLoggingLevel">
		<priority>5</priority>
		<properties>
			<property name="strictMode" value="false" />
		</properties>
	</rule>
	<rule ref="category/apex/bestpractices.xml/UnusedLocalVariable" message="Avoid unused local variables">
		<priority>1</priority>
	</rule>


	<!-- Code Style -->
	<rule
		ref="category/apex/codestyle.xml/ClassNamingConventions"
		message="Class name does not comply with the established nomenclature"
	>
		<priority>1</priority>
		<properties>
			<property name="testClassPattern" value="[A-Z][a-zA-Z0-9_]*_Test" />
			<property name="abstractClassPattern" value="[A-Z][a-zA-Z0-9_]*" />
			<property name="classPattern" value="[A-Z][a-zA-Z0-9_]*" />
			<property name="interfacePattern" value="[A-Z][a-zA-Z0-9_]*" />
			<property name="enumPattern" value="[A-Z][a-zA-Z0-9_]*" />
		</properties>
	</rule>
	<rule ref="category/apex/codestyle.xml/FieldDeclarationsShouldBeAtStart">
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/codestyle.xml/FieldNamingConventions">
		<priority>1</priority>
		<properties>
			<property name="enumConstantPattern" value="[A-Z][A-Z0-9_]*" />
			<property name="constantPattern" value="[A-Z][A-Z0-9_]*" />
			<property name="finalPattern" value="[a-z][a-zA-Z0-9]*" />
			<property name="staticPattern" value="[a-z][a-zA-Z0-9]*" />
			<property name="instancePattern" value="[a-z][a-zA-Z0-9]*" />
		</properties>
	</rule>
	<rule
		ref="category/apex/codestyle.xml/ForLoopsMustUseBraces"
		message="Avoid using 'for' statements without curly braces"
	>
		<priority>2</priority>
	</rule>
	<rule ref="category/apex/codestyle.xml/FormalParameterNamingConventions">
		<priority>1</priority>
		<properties>
			<property name="finalMethodParameterPattern" value="[a-z][a-zA-Z0-9]*" />
			<property name="methodParameterPattern" value="[a-z][a-zA-Z0-9]*" />
		</properties>
	</rule>
	<rule
		ref="category/apex/codestyle.xml/IfElseStmtsMustUseBraces"
		message="Avoid using 'if...else' statements without curly braces"
	>
		<priority>2</priority>
	</rule>
	<rule ref="category/apex/codestyle.xml/IfStmtsMustUseBraces" message="Avoid using if statements without curly braces">
		<priority>2</priority>
	</rule>
	<rule ref="category/apex/codestyle.xml/LocalVariableNamingConventions" message="{0} variable {1} should begin with {2}">
		<priority>1</priority>
		<properties>
			<property name="finalLocalPattern" value="[a-z][a-zA-Z0-9]*" />
			<property name="localPattern" value="[a-z][a-zA-Z0-9]*" />
		</properties>
	</rule>
	<rule
		ref="category/apex/codestyle.xml/MethodNamingConventions"
		message="Method name does not begin with a lower case character."
	>
		<priority>1</priority>
		<properties>
			<property name="testPattern" value="[a-z][a-zA-Z0-9]*Test" />
			<property name="staticPattern" value="[a-z][a-zA-Z0-9]*" />
			<property name="instancePattern" value="[a-z][a-zA-Z0-9]*" />
		</properties>
	</rule>
	<rule ref="category/apex/codestyle.xml/OneDeclarationPerLine">
		<priority>1</priority>
		<properties>
			<property name="strictMode" value="false" />
		</properties>
	</rule>
	<rule ref="category/apex/codestyle.xml/PropertyNamingConventions">
		<priority>1</priority>
		<properties>
			<property name="staticPattern" value="[a-z][a-zA-Z0-9]*" />
			<property name="instancePattern" value="[a-z][a-zA-Z0-9]*" />
		</properties>
	</rule>
	<rule
		ref="category/apex/codestyle.xml/WhileLoopsMustUseBraces"
		message="Avoid using 'while' statements without curly braces"
	>
		<priority>2</priority>
	</rule>


	<!-- Design -->
	<rule
		ref="category/apex/design.xml/AvoidDeeplyNestedIfStmts"
		message="Deeply nested if..else statements are hard to read"
	>
		<priority>2</priority>
		<properties>
			<property name="problemDepth" value="3" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/CognitiveComplexity">
		<priority>3</priority>
		<properties>
			<property name="classReportLevel" value="50" />
			<property name="methodReportLevel" value="15" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/CyclomaticComplexity">
		<priority>3</priority>
		<properties>
			<property name="classReportLevel" value="40" />
			<property name="methodReportLevel" value="10" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/ExcessiveClassLength" message="Avoid really long classes (lines of code)">
		<priority>3</priority>
		<properties>
			<property name="minimum" value="1000" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/ExcessiveParameterList" message="Avoid long parameter lists">
		<priority>3</priority>
		<properties>
			<property name="minimum" value="4" />
		</properties>
	</rule>
	<rule
		ref="category/apex/design.xml/ExcessivePublicCount"
		message="This class has too many public methods and attributes"
	>
		<priority>4</priority>
		<properties>
			<property name="minimum" value="20" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/NcssConstructorCount" message="The constructor has an NCSS line count of {0}">
		<priority>4</priority>
		<properties>
			<property name="minimum" value="30" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/NcssMethodCount" message="The method {0}() has an NCSS line count of {1}">
		<priority>4</priority>
		<properties>
			<property name="minimum" value="80" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/NcssTypeCount" message="The type has an NCSS line count of {0}">
		<priority>5</priority>
		<properties>
			<property name="minimum" value="500" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/StdCyclomaticComplexity">
		<priority>3</priority>
		<properties>
			<property name="reportLevel" value="10" />
			<property name="showClassesComplexity" value="true" />
			<property name="showMethodsComplexity" value="true" />
		</properties>
	</rule>
	<rule ref="category/apex/design.xml/TooManyFields" message="Too many fields">
		<priority>5</priority>
		<properties>
			<property name="maxfields" value="15" />
		</properties>
	</rule>
	<rule ref="category/apex/documentation.xml/ApexDoc">
		<priority>1</priority>
	</rule>


	<!-- Error Prone -->
	<rule
		ref="category/apex/errorprone.xml/ApexCSRF"
		message="Avoid making DML operations in Apex class constructor/init method"
	>
		<priority>1</priority>
	</rule>
	<rule
		ref="category/apex/errorprone.xml/AvoidDirectAccessTriggerMap"
		message="Avoid directly accessing Trigger.old and Trigger.new"
	>
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/AvoidHardcodingId" message="Avoid hardcoding ID's">
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/AvoidNonExistentAnnotations">
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/EmptyCatchBlock" message="Avoid empty catch blocks">
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/EmptyIfStmt" message="Avoid empty 'if' statements">
		<priority>1</priority>
	</rule>
	<!-- TODO: THIS RULE NEEDS TO BE CUSTOMIZED -->
	<rule ref="category/apex/errorprone.xml/EmptyStatementBlock" message="Avoid empty block statements.">
		<priority>3</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/EmptyTryOrFinallyBlock" message="Avoid empty try or finally blocks">
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/EmptyWhileStmt" message="Avoid empty 'while' statements">
		<priority>1</priority>
	</rule>
	<rule
		ref="category/apex/errorprone.xml/MethodWithSameNameAsEnclosingClass"
		message="Classes should not have non-constructor methods with the same name as the class"
	>
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/TestMethodsMustBeInTestClasses">
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/errorprone.xml/OverrideBothEqualsAndHashcode">
		<priority>1</priority>
	</rule>


	<!-- Performance -->
	<rule ref="category/apex/performance.xml/OperationWithLimitsInLoop">
		<priority>1</priority>
	</rule>


	<!-- Security -->
	<rule ref="category/apex/security.xml/ApexBadCrypto" message="Apex Crypto should use random IV/key">
		<priority>1</priority>
	</rule>
	<rule ref="category/apex/security.xml/ApexCRUDViolation" message="Validate CRUD permission before SOQL/DML operation">
		<priority>2</priority>
	</rule>
	<rule ref="category/apex/security.xml/ApexDangerousMethods" message="Calling potentially dangerous method">
		<priority>3</priority>
	</rule>
	<rule
		ref="category/apex/security.xml/ApexInsecureEndpoint"
		message="Apex callouts should use encrypted communication channels"
	>
		<priority>3</priority>
	</rule>
	<rule
		ref="category/apex/security.xml/ApexOpenRedirect"
		message="Apex classes should safely redirect to a known location"
	>
		<priority>3</priority>
	</rule>
	<rule
		ref="category/apex/security.xml/ApexSharingViolations"
		message="Apex classes should declare a sharing model if DML or SOQL is used"
	>
		<priority>2</priority>
	</rule>
	<rule
		ref="category/apex/security.xml/ApexSOQLInjection"
		message="Apex classes should escape variables merged in DML query"
	>
		<priority>1</priority>
	</rule>
	<rule
		ref="category/apex/security.xml/ApexSuggestUsingNamedCred"
		message="Consider using named credentials for authenticated callouts"
	>
		<priority>3</priority>
	</rule>
	<rule ref="category/apex/security.xml/ApexXSSFromEscapeFalse" message="Apex classes should escape addError strings">
		<priority>1</priority>
	</rule>
	<rule
		ref="category/apex/security.xml/ApexXSSFromURLParam"
		message="Apex classes should escape Strings obtained from URL parameters"
	>
		<priority>1</priority>
	</rule>


	<!-- Visual Force -->
  	<rule ref="category/vf/security.xml/VfCsrf">
		<priority>1</priority>
	</rule>
	<rule ref="category/vf/security.xml/VfUnescapeEl">
		<priority>1</priority>
	</rule>

	<!-- TODO: modify rules to include naming conventions on params -->
	<!-- Custom Rules -->
	<rule
		name="ListCollectionNamingConventions"
		language="apex"
		message="Variable declaration names of type List always have to start with (l)"
		class="net.sourceforge.pmd.lang.rule.XPathRule"
	>
		<description>
			Variable declaration names of type List always have to start with (l)
		</description>
		<priority>1</priority>
		<properties>
			<property name="version" value="2.0" />
			<property name="xpath">
				<value>
					<![CDATA[
					//VariableDeclaration[starts-with(@Type, 'List<') and (not(starts-with(@Image, 'l')))]
					]]>
				</value>
			</property>
		</properties>
	</rule>
	<rule
		name="SetCollectionNamingConventions"
		language="apex"
		message="Variable declaration names of type Set always have to start with (s)"
		class="net.sourceforge.pmd.lang.rule.XPathRule"
	>
		<description>
			Variable declaration names of type Set always have to start with (s)
		</description>
		<priority>1</priority>
		<properties>
			<property name="version" value="2.0" />
			<property name="xpath">
				<value>
					<![CDATA[
					//VariableDeclaration[starts-with(@Type, 'Set<') and (not(starts-with(@Image, 's')))]
					]]>
				</value>
			</property>
		</properties>
	</rule>
	<rule
		name="MapCollectionNamingConventions"
		language="apex"
		message="Variable declaration names of type Map always have to start with (m) and contains (By)"
		class="net.sourceforge.pmd.lang.rule.XPathRule"
	>
		<description>
			Variable declaration names of type Map always have to start with (m) and contains (By)
		</description>
		<priority>1</priority>
		<properties>
			<property name="version" value="2.0" />
			<property name="xpath">
				<value>
					<![CDATA[
					//VariableDeclaration[starts-with(@Type, 'Map<') and ((not(starts-with(@Image, 'm')) or (not(contains(@Image, 'By')))))]
					]]>
				</value>
			</property>
		</properties>
	</rule>

	<!-- TODO: review if PMD VSCode version is updated. In this case use standard rule instead of this one -->
    <rule
		name="AvoidDebugStatements"
		language="apex"
		message="Avoid debug statements since they impact on performance"
		class="net.sourceforge.pmd.lang.rule.XPathRule"
	>
        <description>
			Debug statements contribute to longer transactions and consume Apex CPU time even when debug logs are not being captured.

			When possible make use of other debugging techniques such as the Apex Replay Debugger and Checkpoints that could cover *most* use cases.

			For other valid use cases that the statement is in fact valid make use of the `@SuppressWarnings` annotation or the `//NOPMD` comment.
        </description>
        <priority>1</priority>
        <properties>
            <property name="version" value="2.0" />
            <property name="xpath">
                <value>
					<![CDATA[
					//MethodCallExpression[lower-case(@FullMethodName)='system.debug']
					]]>
				</value>
			</property>
		</properties>
		<example>
			<![CDATA[
			public class Foo {
				public void bar() {
					Account acc = [SELECT Name, Owner.Name FROM Account LIMIT 1];
					System.debug(accs); // will get reported
				}
				@SuppressWarnings('PMD.AvoidDebugStatements')
				public void baz() {
					try {
						Account myAccount = bar();
					} catch (Exception e) {
						System.debug(LoggingLevel.ERROR, e.getMessage()); // good to go
					}
				}
			}
			]]>
        </example>
    </rule>
</ruleset>
